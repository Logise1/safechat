<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeChat - Plataforma Segura</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs (Compat versions) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

    <style>
        /* CORRECCI√ìN DE ALTURA: Aseguramos que el root y el body ocupen todo el alto */
        html, body, #root {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            font-family: 'Nunito', sans-serif;
            overflow: hidden; /* Evitamos scroll doble */
        }
        .kid-font { font-family: 'Fredoka', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyC1XbhA7TTz7gn-3_SFJ53p7DPfq36eRdg",
            authDomain: "safechat-224e2.firebaseapp.com",
            projectId: "safechat-224e2",
            storageBucket: "safechat-224e2.firebasestorage.app",
            messagingSenderId: "390500687585",
            appId: "1:390500687585:web:36fc0ce72b58e02351e1a0",
            measurementId: "G-C7TZK5P9W6"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'safechat-default';

        const USERS_COLLECTION = `artifacts/${appId}/public/data/users`;
        const CHATS_COLLECTION = `artifacts/${appId}/public/data/chats`;

        // --- ICONS ---
        const IconShield = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>;
        const IconEye = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconLock = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
        const IconQr = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><path d="M3 14h1v1H3z"/><path d="M5 14h1v1H5z"/><path d="M3 16h1v1H3z"/><path d="M5 16h1v1H5z"/><path d="M3 18h1v1H3z"/><path d="M5 18h1v1H5z"/><path d="M7 14h1v1H7z"/><path d="M9 14h1v1H9z"/><path d="M7 16h1v1H7z"/><path d="M9 16h1v1H9z"/><path d="M7 18h1v1H7z"/><path d="M9 18h1v1H9z"/></svg>;
        const IconSend = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
        const IconBack = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>;
        const IconUserPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;
        const IconMail = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>;
        const IconLogOut = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>;

        // --- COMPONENTS ---

        const DynamicQR = () => {
            const canvasRef = useRef(null);
            const [seed, setSeed] = useState(0);

            useEffect(() => {
                const interval = setInterval(() => {
                    setSeed(prev => prev + 1);
                    drawNoise();
                }, 500);
                return () => clearInterval(interval);
            }, []);

            const drawNoise = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;
                const pixelSize = 20;
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, w, h);
                ctx.fillStyle = "black";
                for (let y = 0; y < h; y += pixelSize) {
                    for (let x = 0; x < w; x += pixelSize) {
                        if (Math.random() > 0.5) ctx.fillRect(x, y, pixelSize, pixelSize);
                    }
                }
                const drawSquare = (x, y) => {
                    ctx.fillStyle = "black";
                    ctx.fillRect(x, y, 60, 60);
                    ctx.clearRect(x+10, y+10, 40, 40);
                    ctx.fillRect(x+20, y+20, 20, 20);
                }
                drawSquare(0, 0);
                drawSquare(w-60, 0);
                drawSquare(0, h-60);
            };

            return (
                <div className="flex flex-col items-center justify-center p-4 bg-white rounded-xl shadow-lg border-4 border-blue-400">
                    <canvas ref={canvasRef} width={200} height={200} className="mb-2" />
                    <div className="flex items-center gap-2 text-blue-600 font-bold text-xs animate-pulse">
                        <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span>Actualizando c√≥digo...</span>
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ onLogin }) => {
            // Mode: 'welcome', 'login', 'register_role', 'register_form'
            const [mode, setMode] = useState('welcome'); 
            const [role, setRole] = useState(null); // 'kid' | 'parent'
            
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [name, setName] = useState("");
            
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError("");
                try {
                    const result = await auth.signInWithEmailAndPassword(email, password);
                    // El listener global en App manejar√° el resto
                } catch (err) {
                    setError("Error al entrar: " + err.message);
                    setLoading(false);
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                if (!name || !email || !password) return;
                setLoading(true);
                setError("");

                try {
                    const result = await auth.createUserWithEmailAndPassword(email, password);
                    const user = result.user;
                    const familyCode = Math.random().toString(36).substring(2, 8).toUpperCase();

                    const userData = {
                        name: name,
                        role: role,
                        email: email,
                        familyCode: familyCode,
                        linkedWith: null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection(USERS_COLLECTION).doc(user.uid).set(userData);
                    // El listener global detectar√° el cambio y loguear√°
                } catch (err) {
                    setError("Error al registrar: " + err.message);
                    setLoading(false);
                }
            };

            // 1. WELCOME SCREEN
            if (mode === 'welcome') {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-blue-500 to-indigo-600 text-white slide-in">
                        <div className="mb-6 bg-white/20 p-6 rounded-full backdrop-blur-md shadow-xl">
                            <IconShield />
                        </div>
                        <h1 className="text-5xl font-bold mb-2 kid-font">SafeChat</h1>
                        <p className="mb-12 text-blue-100 text-lg">Conexiones seguras para tu familia.</p>

                        <div className="w-full max-w-sm space-y-4">
                            <button 
                                onClick={() => setMode('login')}
                                className="w-full bg-white text-blue-600 font-bold py-4 rounded-xl shadow-lg transition hover:scale-105"
                            >
                                Iniciar Sesi√≥n
                            </button>
                            <button 
                                onClick={() => setMode('register_role')}
                                className="w-full bg-blue-700/50 border border-blue-400 text-white font-bold py-4 rounded-xl shadow-lg transition hover:bg-blue-700/70"
                            >
                                Crear Cuenta Nueva
                            </button>
                        </div>
                    </div>
                );
            }

            // 2. ROLE SELECTION (For Register)
            if (mode === 'register_role') {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-6 bg-white slide-in">
                        <h2 className="text-3xl font-bold mb-8 text-gray-800 text-center">¬øQui√©n eres?</h2>
                        <div className="w-full max-w-sm space-y-4">
                            <button 
                                onClick={() => { setRole('kid'); setMode('register_form'); }}
                                className="w-full p-6 bg-blue-50 border-2 border-blue-100 rounded-2xl flex items-center gap-4 hover:border-blue-500 transition group"
                            >
                                <span className="text-4xl group-hover:scale-110 transition">üßí</span>
                                <div className="text-left">
                                    <h3 className="font-bold text-xl text-blue-900">Soy un Ni√±o</h3>
                                    <p className="text-sm text-blue-600">Quiero chatear con mis amigos.</p>
                                </div>
                            </button>
                            <button 
                                onClick={() => { setRole('parent'); setMode('register_form'); }}
                                className="w-full p-6 bg-purple-50 border-2 border-purple-100 rounded-2xl flex items-center gap-4 hover:border-purple-500 transition group"
                            >
                                <span className="text-4xl group-hover:scale-110 transition">üëÆ</span>
                                <div className="text-left">
                                    <h3 className="font-bold text-xl text-purple-900">Soy Padre/Madre</h3>
                                    <p className="text-sm text-purple-600">Quiero proteger a mi hijo.</p>
                                </div>
                            </button>
                        </div>
                        <button onClick={() => setMode('welcome')} className="mt-8 text-gray-400">Volver</button>
                    </div>
                );
            }

            // 3. REGISTER FORM
            if (mode === 'register_form') {
                return (
                    <div className="h-full flex flex-col justify-center p-8 bg-white slide-in max-w-md mx-auto w-full">
                        <button onClick={() => setMode('register_role')} className="self-start mb-4 text-gray-400"><IconBack /></button>
                        <h2 className="text-2xl font-bold mb-1 text-gray-800">Crea tu cuenta</h2>
                        <p className="text-sm text-gray-500 mb-6">Rol seleccionado: <strong className="capitalize">{role === 'kid' ? 'Ni√±o' : 'Padre/Madre'}</strong></p>
                        
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4">{error}</div>}

                        <form onSubmit={handleRegister} className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Nombre</label>
                                <input type="text" required className="w-full p-3 border rounded-lg" value={name} onChange={e => setName(e.target.value)} placeholder="Ej: Leo" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Email</label>
                                <input type="email" required className="w-full p-3 border rounded-lg" value={email} onChange={e => setEmail(e.target.value)} placeholder="correo@ejemplo.com" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Contrase√±a</label>
                                <input type="password" required className="w-full p-3 border rounded-lg" value={password} onChange={e => setPassword(e.target.value)} placeholder="******" />
                            </div>
                            <button disabled={loading} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4 disabled:opacity-50">
                                {loading ? 'Creando...' : 'Registrarme'}
                            </button>
                        </form>
                    </div>
                );
            }

            // 4. LOGIN FORM
            if (mode === 'login') {
                return (
                    <div className="h-full flex flex-col justify-center p-8 bg-white slide-in max-w-md mx-auto w-full">
                        <button onClick={() => setMode('welcome')} className="self-start mb-4 text-gray-400"><IconBack /></button>
                        <h2 className="text-3xl font-bold mb-6 text-gray-800">Bienvenido de nuevo</h2>
                        
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4">{error}</div>}

                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Email</label>
                                <input type="email" required className="w-full p-3 border rounded-lg" value={email} onChange={e => setEmail(e.target.value)} />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Contrase√±a</label>
                                <input type="password" required className="w-full p-3 border rounded-lg" value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            <button disabled={loading} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg mt-6 disabled:opacity-50">
                                {loading ? 'Entrando...' : 'Entrar'}
                            </button>
                        </form>
                    </div>
                );
            }
        };

        const LinkScreen = ({ user, userData, onLinked }) => {
            const [code, setCode] = useState("");
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");

            useEffect(() => {
                const unsub = db.collection(USERS_COLLECTION).doc(user.uid)
                    .onSnapshot(doc => {
                        if (doc.data()?.linkedWith) {
                            onLinked(doc.data().linkedWith);
                        }
                    });
                return () => unsub();
            }, []);

            const handleLink = async () => {
                setLoading(true);
                setError("");
                try {
                    const snapshot = await db.collection(USERS_COLLECTION).where('familyCode', '==', code.toUpperCase().trim()).get();
                    if (snapshot.empty) throw new Error("C√≥digo no encontrado");
                    
                    const targetDoc = snapshot.docs[0];
                    const targetId = targetDoc.id;

                    const batch = db.batch();
                    batch.update(db.collection(USERS_COLLECTION).doc(user.uid), { linkedWith: targetId });
                    batch.update(db.collection(USERS_COLLECTION).doc(targetId), { linkedWith: user.uid });
                    await batch.commit();

                    onLinked(targetId);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="h-full w-full bg-white p-8 flex flex-col items-center justify-center max-w-lg mx-auto">
                    <h2 className="text-2xl font-bold mb-2 text-center">Vincular Familia</h2>
                    <p className="text-center text-gray-500 mb-8 text-sm">
                        {userData.role === 'parent' 
                            ? "Comparte este c√≥digo con tu hijo para vincularlo." 
                            : "Pide el c√≥digo a tu padre/madre para entrar."}
                    </p>

                    <div className="bg-blue-50 p-6 rounded-2xl border-2 border-blue-100 text-center mb-8 w-full">
                        <p className="text-xs text-blue-400 uppercase font-bold tracking-wider mb-2">Tu C√≥digo Familiar</p>
                        <p className="text-4xl font-mono font-bold text-blue-600 tracking-widest select-all">{userData.familyCode}</p>
                    </div>

                    <div className="w-full border-t border-gray-100 pt-8">
                        <p className="text-sm font-bold text-gray-700 mb-2">O ingresa el c√≥digo de ellos:</p>
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                className="flex-1 border-2 border-gray-200 rounded-lg px-4 uppercase font-mono"
                                placeholder="C√ìDIGO"
                                maxLength={6}
                            />
                            <button 
                                onClick={handleLink}
                                disabled={loading || code.length < 3}
                                className="bg-green-500 text-white px-6 py-3 rounded-lg font-bold disabled:opacity-50"
                            >
                                {loading ? "..." : "Vincular"}
                            </button>
                        </div>
                        {error && <p className="text-red-500 text-xs mt-2">{error}</p>}
                    </div>
                    
                    <button onClick={() => auth.signOut()} className="mt-12 text-gray-400 text-sm flex items-center gap-2">
                        <IconLogOut /> Cerrar Sesi√≥n
                    </button>
                </div>
            );
        };

        const ChatApp = ({ user, userData, linkedUserId }) => {
            const [chats, setChats] = useState([]);
            const [activeChat, setActiveChat] = useState(null);
            const [view, setView] = useState('list'); 
            const [friendCodeInput, setFriendCodeInput] = useState("");

            useEffect(() => {
                let query = db.collection(CHATS_COLLECTION);
                
                if (userData.role === 'kid') {
                    query = query.where('participants', 'array-contains', user.uid);
                } else {
                    if (linkedUserId) {
                        query = query.where('participants', 'array-contains', linkedUserId);
                    }
                }

                const unsubscribe = query.onSnapshot(snapshot => {
                    const loadedChats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    loadedChats.sort((a, b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0));
                    setChats(loadedChats);
                });
                return () => unsubscribe();
            }, [user.uid, linkedUserId, userData.role]);

            const handleSendMessage = async (text) => {
                if (!activeChat || !text.trim()) return;
                
                const newMessage = {
                    text,
                    senderId: user.uid,
                    senderName: userData.name,
                    createdAt: new Date().toISOString()
                };

                const chatRef = db.collection(CHATS_COLLECTION).doc(activeChat.id);
                await chatRef.update({
                    messages: firebase.firestore.FieldValue.arrayUnion(newMessage),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            };

            const handleAddFriend = async () => {
                if (!friendCodeInput) return;
                try {
                    const snap = await db.collection(USERS_COLLECTION).where('familyCode', '==', friendCodeInput.toUpperCase().trim()).get();
                    if (snap.empty) {
                        alert("C√≥digo de amigo no encontrado.");
                        return;
                    }
                    const friendDoc = snap.docs[0];
                    const friendData = friendDoc.data();
                    
                    if (friendData.role !== 'kid') {
                        alert("Solo puedes a√±adir a otros ni√±os.");
                        return;
                    }

                    await db.collection(CHATS_COLLECTION).add({
                        participants: [user.uid, friendDoc.id],
                        participantNames: { [user.uid]: userData.name, [friendDoc.id]: friendData.name },
                        messages: [],
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    setView('list');
                    setFriendCodeInput("");
                } catch (e) {
                    console.error(e);
                    alert("Error al a√±adir amigo: " + e.message);
                }
            };

            // VISTA CHAT INDIVIDUAL
            if (view === 'chat' && activeChat) {
                const liveChat = chats.find(c => c.id === activeChat.id) || activeChat;
                const friendName = Object.values(liveChat.participantNames || {}).find(n => n !== userData.name) || "Amigo";

                return (
                    <div className="flex flex-col h-full w-full bg-gray-50">
                        <div className="bg-white p-4 flex items-center shadow-sm sticky top-0 z-10">
                            <button onClick={() => setView('list')} className="p-2 mr-2 hover:bg-gray-100 rounded-full"><IconBack /></button>
                            <h2 className="font-bold text-lg">{friendName}</h2>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar flex flex-col">
                            {liveChat.messages?.map((msg, i) => {
                                const isMe = msg.senderId === user.uid;
                                return (
                                    <div key={i} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[70%] p-3 rounded-xl text-sm ${isMe ? 'bg-blue-500 text-white rounded-br-none' : 'bg-white border border-gray-200 rounded-bl-none'}`}>
                                            {!isMe && userData.role === 'parent' && <p className="text-[10px] text-gray-400 font-bold mb-1">{msg.senderName}</p>}
                                            <p>{msg.text}</p>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>

                        {userData.role === 'kid' && (
                            <div className="p-3 bg-white border-t flex gap-2 safe-area-bottom">
                                <input 
                                    className="flex-1 bg-gray-100 rounded-full px-4 py-2 outline-none"
                                    placeholder="Mensaje..."
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter') {
                                            handleSendMessage(e.target.value);
                                            e.target.value = '';
                                        }
                                    }}
                                />
                            </div>
                        )}
                        {userData.role === 'parent' && (
                            <div className="p-2 bg-yellow-50 text-center text-xs text-yellow-700 border-t border-yellow-200">
                                Modo Observador: Solo lectura
                            </div>
                        )}
                    </div>
                );
            }

            // VISTA A√ëADIR AMIGO
            if (view === 'add_friend') {
                return (
                    <div className="flex flex-col h-full w-full bg-slate-900 text-white">
                        <div className="p-4"><button onClick={() => setView('list')} className="bg-white/10 p-2 rounded-full"><IconBack /></button></div>
                        <div className="flex-1 flex flex-col items-center justify-center p-6 text-center max-w-lg mx-auto">
                            <h2 className="text-2xl font-bold kid-font mb-6">Escanea para a√±adir</h2>
                            <DynamicQR />
                            <div className="mt-8 w-full max-w-xs">
                                <p className="text-sm text-gray-400 mb-2">O escribe el c√≥digo de tu amigo:</p>
                                <div className="flex gap-2">
                                    <input 
                                        className="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white text-center uppercase" 
                                        placeholder="C√ìDIGO"
                                        value={friendCodeInput}
                                        onChange={e => setFriendCodeInput(e.target.value)}
                                    />
                                    <button onClick={handleAddFriend} className="bg-blue-500 px-4 rounded-lg font-bold">OK</button>
                                </div>
                            </div>
                            <div className="mt-8 p-4 bg-slate-800 rounded-lg">
                                <p className="text-xs text-gray-400 uppercase tracking-widest mb-1">Tu C√≥digo</p>
                                <p className="text-2xl font-mono font-bold text-blue-400">{userData.familyCode}</p>
                            </div>
                        </div>
                    </div>
                )
            }

            // VISTA LISTA DE CHATS
            return (
                <div className="flex flex-col h-full w-full bg-white relative">
                    <div className={`${userData.role === 'parent' ? 'bg-slate-800' : 'bg-blue-500'} p-6 text-white rounded-b-3xl shadow-lg z-10`}>
                        <div className="flex justify-between items-center mb-4 max-w-4xl mx-auto">
                            <div>
                                <h1 className="text-2xl font-bold kid-font">Hola, {userData.name}</h1>
                                <p className="text-sm opacity-80">{userData.role === 'parent' ? 'Supervisando cuenta' : '¬°A jugar!'}</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={() => auth.signOut()} className="bg-white/20 p-2 rounded-full hover:bg-red-500 hover:text-white transition" title="Salir">
                                    <IconLogOut />
                                </button>
                                <div className="bg-white/20 p-2 rounded-full text-xl">
                                    {userData.role === 'parent' ? 'üõ°Ô∏è' : 'ü¶Å'}
                                </div>
                            </div>
                        </div>
                        {userData.role === 'parent' && (
                            <div className="max-w-4xl mx-auto bg-slate-700/50 p-2 rounded-lg text-xs flex items-center gap-2">
                                <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                Sincronizado con ID hijo: {linkedUserId ? linkedUserId.substring(0,5) : '...'}...
                            </div>
                        )}
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-24 max-w-4xl mx-auto w-full">
                        {chats.length === 0 ? (
                            <div className="text-center text-gray-400 mt-10">
                                <p className="text-4xl mb-2">üì≠</p>
                                <p>No hay chats a√∫n.</p>
                            </div>
                        ) : (
                            chats.map(chat => {
                                const friendName = Object.values(chat.participantNames || {}).find(n => n !== userData.name) || "Usuario";
                                const lastMsg = chat.messages?.[chat.messages.length - 1];
                                return (
                                    <div 
                                        key={chat.id} 
                                        onClick={() => { setActiveChat(chat); setView('chat'); }}
                                        className="bg-white border border-gray-100 p-4 rounded-xl shadow-sm flex items-center gap-4 hover:bg-gray-50 transition cursor-pointer"
                                    >
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl ${userData.role === 'parent' ? 'bg-gray-200' : 'bg-purple-100'}`}>
                                            {userData.role === 'parent' ? 'üë§' : 'ü¶Ñ'}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <h3 className="font-bold text-gray-800">{friendName}</h3>
                                            <p className="text-sm text-gray-500 truncate">{lastMsg ? lastMsg.text : 'Nuevo chat'}</p>
                                        </div>
                                    </div>
                                )
                            })
                        )}
                    </div>

                    {userData.role === 'kid' && (
                        <div className="absolute bottom-6 right-6">
                            <button 
                                onClick={() => setView('add_friend')}
                                className="bg-green-500 hover:bg-green-600 text-white p-4 rounded-full shadow-xl flex items-center gap-2 font-bold transition transform hover:scale-105"
                            >
                                <IconUserPlus /> Nuevo Amigo
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // 6. MAIN ORCHESTRATOR
        const App = () => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        const doc = await db.collection(USERS_COLLECTION).doc(u.uid).get();
                        if (doc.exists) {
                            setUserData(doc.data());
                            setUser(u);
                        } else {
                            // Usuario autenticado pero sin datos en Firestore (raro, pero posible si falla el registro a medias)
                            // Forzamos logout para reintentar
                            if (!loading) auth.signOut();
                        }
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) return (
                <div className="h-full w-full flex items-center justify-center bg-blue-500 text-white">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
                </div>
            );

            // 1. Auth Screen (Login/Register)
            if (!user || !userData) {
                return <div className="w-full h-full bg-white"><AuthScreen /></div>;
            }

            // 2. Link Parent/Kid if not linked
            if (!userData.linkedWith) {
                return <div className="w-full h-full bg-white"><LinkScreen user={user} userData={userData} onLinked={() => {}} /></div>;
            }

            // 3. Main App
            return <div className="w-full h-full bg-white"><ChatApp user={user} userData={userData} linkedUserId={userData.linkedWith} /></div>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
