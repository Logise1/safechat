<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeChat Family - Protecci√≥n Total</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

    <style>
        html, body, #root { height: 100%; width: 100%; margin: 0; padding: 0; background-color: #f8fafc; font-family: 'Nunito', sans-serif; overflow: hidden; }
        .kid-font { font-family: 'Fredoka', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyC1XbhA7TTz7gn-3_SFJ53p7DPfq36eRdg",
            authDomain: "safechat-224e2.firebaseapp.com",
            projectId: "safechat-224e2",
            storageBucket: "safechat-224e2.firebasestorage.app",
            messagingSenderId: "390500687585",
            appId: "1:390500687585:web:36fc0ce72b58e02351e1a0",
            measurementId: "G-C7TZK5P9W6"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'safechat-v2';

        const USERS_COLLECTION = `artifacts/${appId}/public/data/users`;
        const CHATS_COLLECTION = `artifacts/${appId}/public/data/chats`;

        // --- ICONS ---
        const Icon = ({ name, size=24, className="" }) => {
            const icons = {
                shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
                users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
                clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                qr: <><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><path d="M3 14h1v1H3z"/></>,
                plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                logOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>,
                camera: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
                back: <path d="m15 18-6-6 6-6"/>,
                settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        // --- COMPONENTS ---

        const DynamicQR = ({ value }) => {
            const canvasRef = useRef(null);
            const [seed, setSeed] = useState(0);

            useEffect(() => {
                const interval = setInterval(() => {
                    setSeed(prev => prev + 1);
                    drawNoise();
                }, 500); // 0.5s refresh
                return () => clearInterval(interval);
            }, []);

            const drawNoise = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;
                const pixelSize = 15;
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, w, h);
                ctx.fillStyle = "black";
                for (let y = 0; y < h; y += pixelSize) {
                    for (let x = 0; x < w; x += pixelSize) {
                        if (Math.random() > 0.5) ctx.fillRect(x, y, pixelSize, pixelSize);
                    }
                }
                // Positioning markers
                const drawMarker = (x, y) => {
                    ctx.fillRect(x, y, 50, 50);
                    ctx.clearRect(x+10, y+10, 30, 30);
                    ctx.fillRect(x+15, y+15, 20, 20);
                }
                drawMarker(10, 10);
                drawMarker(w-60, 10);
                drawMarker(10, h-60);
            };

            return (
                <div className="relative p-4 bg-white rounded-xl shadow-lg border-4 border-blue-400 inline-block">
                    <canvas ref={canvasRef} width={180} height={180} className="mb-2" />
                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white/90 px-2 py-1 rounded text-xs font-mono font-bold">
                        {value}
                    </div>
                    <div className="flex items-center justify-center gap-2 text-blue-600 font-bold text-[10px] animate-pulse uppercase tracking-wider">
                        <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                        QR Seguro: Cambia cada 0.5s
                    </div>
                </div>
            );
        };

        // --- PARENT DASHBOARD ---
        const ParentDashboard = ({ user, userData }) => {
            const [children, setChildren] = useState([]);
            const [selectedChild, setSelectedChild] = useState(null);
            const [view, setView] = useState('list'); // 'list', 'child_detail'
            const [showLinkModal, setShowLinkModal] = useState(false);
            const [linkCode, setLinkCode] = useState("");
            
            // Listen to children updates instantly
            useEffect(() => {
                const unsub = db.collection(USERS_COLLECTION)
                    .where('parentId', '==', user.uid)
                    .onSnapshot(snap => {
                        const kids = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        setChildren(kids);
                    });
                return () => unsub();
            }, [user.uid]);

            const handleLinkChild = async () => {
                if(!linkCode) return;
                try {
                    const snap = await db.collection(USERS_COLLECTION).where('familyCode', '==', linkCode.toUpperCase().trim()).get();
                    if(snap.empty) { alert("C√≥digo no v√°lido"); return; }
                    
                    const childDoc = snap.docs[0];
                    if(childDoc.data().role !== 'kid') { alert("Este c√≥digo no pertenece a un perfil de ni√±o."); return; }
                    
                    // Update child with parent ID
                    await db.collection(USERS_COLLECTION).doc(childDoc.id).update({
                        parentId: user.uid,
                        linkedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setLinkCode("");
                    setShowLinkModal(false);
                } catch(e) {
                    alert("Error: " + e.message);
                }
            };

            const updateTimeLimit = async (childId, minutes) => {
                await db.collection(USERS_COLLECTION).doc(childId).update({
                    dailyLimit: minutes
                });
            };

            return (
                <div className="flex h-full bg-slate-100">
                    {/* Sidebar */}
                    <div className="w-20 md:w-64 bg-slate-900 text-white flex flex-col items-center md:items-start py-6">
                        <div className="px-4 mb-8 flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-lg"><Icon name="shield" /></div>
                            <span className="font-bold text-xl hidden md:block">SafeParent</span>
                        </div>
                        
                        <div className="flex-1 w-full px-2 space-y-2">
                            <button onClick={() => {setSelectedChild(null); setView('list')}} className={`w-full p-3 rounded-xl flex items-center gap-3 transition ${!selectedChild ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}>
                                <Icon name="users" /> <span className="hidden md:block">Mis Hijos</span>
                            </button>
                            {children.map(child => (
                                <button key={child.id} onClick={() => {setSelectedChild(child); setView('child_detail')}} className={`w-full p-3 rounded-xl flex items-center gap-3 transition ${selectedChild?.id === child.id ? 'bg-slate-800 text-white border-l-4 border-blue-500' : 'text-slate-400 hover:bg-slate-800'}`}>
                                    <span className="text-xl">ü¶Å</span> <span className="hidden md:block truncate">{child.name}</span>
                                </button>
                            ))}
                        </div>

                        <div className="mt-auto px-4 w-full">
                            <button onClick={() => auth.signOut()} className="flex items-center gap-2 text-slate-500 hover:text-white transition">
                                <Icon name="logOut" /> <span className="hidden md:block">Salir</span>
                            </button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden">
                        {/* Header */}
                        <div className="bg-white border-b border-gray-200 p-6 flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-slate-800">
                                {selectedChild ? `Gestionando a ${selectedChild.name}` : 'Panel General'}
                            </h2>
                            {!selectedChild && (
                                <button onClick={() => setShowLinkModal(true)} className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm">
                                    <Icon name="plus" size={18} /> Vincular Hijo
                                </button>
                            )}
                        </div>

                        <div className="flex-1 overflow-y-auto p-6">
                            {!selectedChild ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {/* Stats Cards */}
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <p className="text-slate-500 text-sm">Hijos Protegidos</p>
                                                <h3 className="text-3xl font-bold text-slate-800">{children.length}</h3>
                                            </div>
                                            <div className="p-3 bg-blue-50 text-blue-600 rounded-xl"><Icon name="users" /></div>
                                        </div>
                                    </div>
                                    {children.length === 0 && (
                                        <div className="col-span-full text-center py-20 bg-white rounded-3xl border-2 border-dashed border-slate-200">
                                            <div className="mx-auto w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 mb-4"><Icon name="plus" size={32}/></div>
                                            <h3 className="text-lg font-bold text-slate-700">A√∫n no has vinculado ning√∫n dispositivo</h3>
                                            <p className="text-slate-500 mb-6">Usa el c√≥digo que aparece en la pantalla de tu hijo.</p>
                                            <button onClick={() => setShowLinkModal(true)} className="text-blue-600 font-bold hover:underline">Vincular ahora</button>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {/* Child Settings */}
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="settings" /> Configuraci√≥n de Tiempo</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <div className="flex justify-between mb-2">
                                                    <label className="text-sm font-bold text-slate-600">L√≠mite Diario</label>
                                                    <span className="text-blue-600 font-bold">{selectedChild.dailyLimit || 120} min</span>
                                                </div>
                                                <input 
                                                    type="range" 
                                                    min="30" 
                                                    max="240" 
                                                    step="30"
                                                    value={selectedChild.dailyLimit || 120} 
                                                    onChange={(e) => updateTimeLimit(selectedChild.id, parseInt(e.target.value))}
                                                    className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                                />
                                                <p className="text-xs text-slate-400 mt-2">La app se bloquear√° cuando se alcance el l√≠mite.</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Recent Chats Preview (Mock for now, normally would query chats) */}
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                        <h3 className="text-lg font-bold text-slate-800 mb-4">Actividad Reciente</h3>
                                        <p className="text-slate-500 italic">Selecciona "Ver Chats" para auditar conversaciones detalladas.</p>
                                        <button className="mt-4 w-full border border-blue-200 text-blue-600 py-3 rounded-xl font-bold hover:bg-blue-50 transition">
                                            Abrir Monitor de Chats
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Modal Vincular */}
                    {showLinkModal && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl">
                                <h3 className="text-2xl font-bold mb-2">Vincular Dispositivo Hijo</h3>
                                <p className="text-slate-500 mb-6">Ingresa el c√≥digo que aparece en la pantalla de inicio de la app del ni√±o.</p>
                                <input 
                                    type="text" 
                                    placeholder="C√ìDIGO (Ej: A1B2C3)" 
                                    className="w-full text-center text-3xl font-mono uppercase border-2 border-slate-200 rounded-xl p-4 mb-6 focus:border-blue-500 outline-none tracking-widest"
                                    value={linkCode}
                                    onChange={e => setLinkCode(e.target.value)}
                                />
                                <div className="flex gap-3">
                                    <button onClick={() => setShowLinkModal(false)} className="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl">Cancelar</button>
                                    <button onClick={handleLinkChild} className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg">Vincular</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- KID APP ---
        const KidApp = ({ user, userData }) => {
            const [chats, setChats] = useState([]);
            const [view, setView] = useState('list'); // 'list', 'chat', 'camera'
            const [activeChat, setActiveChat] = useState(null);

            // Fetch Chats
            useEffect(() => {
                const unsub = db.collection(CHATS_COLLECTION)
                    .where('participants', 'array-contains', user.uid)
                    .orderBy('lastUpdated', 'desc')
                    .onSnapshot(snap => {
                        setChats(snap.docs.map(d => ({id: d.id, ...d.data()})));
                    });
                return () => unsub();
            }, [user.uid]);

            // Simulate QR Scan
            const handleScanQR = async () => {
                // In a real app, this opens camera. Here we prompt for "what the camera sees"
                const codeScanned = prompt("üì∑ [SIMULACI√ìN DE C√ÅMARA]\nApunte al c√≥digo del amigo.\n\n(Para probar, escribe el c√≥digo de otro usuario 'kid'):");
                if(!codeScanned) return;

                try {
                    const snap = await db.collection(USERS_COLLECTION).where('familyCode', '==', codeScanned.toUpperCase().trim()).get();
                    if(snap.empty) { alert("‚ùå C√≥digo QR no v√°lido o expirado."); return; }
                    
                    const friend = snap.docs[0].data();
                    if(friend.role !== 'kid') { alert("‚ùå Solo puedes hacer amigos con otros ni√±os."); return; }
                    if(snap.docs[0].id === user.uid) { alert("üòÖ ¬°No puedes a√±adirte a ti mismo!"); return; }

                    // Create Chat
                    await db.collection(CHATS_COLLECTION).add({
                        participants: [user.uid, snap.docs[0].id],
                        participantNames: { [user.uid]: userData.name, [snap.docs[0].id]: friend.name },
                        messages: [],
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert(`‚úÖ ¬°Conectado con ${friend.name}!`);
                    setView('list');

                } catch(e) {
                    alert("Error: " + e.message);
                }
            };

            const sendMessage = async (text) => {
                if(!text.trim()) return;
                await db.collection(CHATS_COLLECTION).doc(activeChat.id).update({
                    messages: firebase.firestore.FieldValue.arrayUnion({
                        text,
                        senderId: user.uid,
                        createdAt: new Date().toISOString()
                    }),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            };

            // Not linked yet state
            if (!userData.parentId) {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-blue-500 text-white p-6 text-center">
                        <div className="bg-white p-4 rounded-3xl mb-6 shadow-xl">
                            <DynamicQR value={userData.familyCode} />
                        </div>
                        <h1 className="text-4xl font-bold kid-font mb-2">¬°Hola, {userData.name}!</h1>
                        <p className="text-xl opacity-90 mb-8 max-w-xs mx-auto">Muestra este c√≥digo a tus padres para activar tu cuenta.</p>
                        <div className="bg-white/20 px-6 py-3 rounded-full animate-pulse font-bold text-sm">
                            Esperando vinculaci√≥n...
                        </div>
                        <button onClick={() => auth.signOut()} className="mt-12 text-white/60 text-sm hover:text-white">Salir</button>
                    </div>
                );
            }

            // Normal Kid UI
            return (
                <div className="h-full bg-white flex flex-col max-w-md mx-auto shadow-2xl overflow-hidden relative">
                    {/* Top Bar */}
                    <div className="bg-blue-500 p-4 rounded-b-3xl shadow-lg z-10 text-white flex justify-between items-center">
                        {view === 'list' ? (
                            <>
                                <div>
                                    <h1 className="text-2xl font-bold kid-font">Hola, {userData.name}</h1>
                                    <p className="text-xs opacity-80">Tiempo restante: {userData.dailyLimit || 120} min</p>
                                </div>
                                <button onClick={() => auth.signOut()} className="bg-white/20 p-2 rounded-full"><Icon name="logOut" /></button>
                            </>
                        ) : (
                            <div className="flex items-center w-full">
                                <button onClick={() => setView('list')} className="p-2 mr-2 bg-white/20 rounded-full"><Icon name="back" /></button>
                                <span className="font-bold text-lg kid-font">Chat</span>
                            </div>
                        )}
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto bg-slate-50 relative">
                        {view === 'list' && (
                            <div className="p-4 space-y-3 pb-24">
                                {chats.length === 0 ? (
                                    <div className="text-center mt-20 opacity-50">
                                        <div className="text-6xl mb-4">ü¶ï</div>
                                        <p className="kid-font text-xl">¬°Sin amigos a√∫n!</p>
                                        <p className="text-sm mt-2">Usa el bot√≥n de c√°mara para escanear.</p>
                                    </div>
                                ) : (
                                    chats.map(chat => {
                                        const friendName = Object.values(chat.participantNames).find(n => n !== userData.name);
                                        const lastMsg = chat.messages[chat.messages.length - 1]?.text || "¬°Nuevo amigo!";
                                        return (
                                            <div key={chat.id} onClick={() => { setActiveChat(chat); setView('chat'); }} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 active:scale-95 transition">
                                                <div className="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-xl">ü¶Ñ</div>
                                                <div className="flex-1">
                                                    <h3 className="font-bold text-slate-800">{friendName}</h3>
                                                    <p className="text-slate-400 text-sm truncate">{lastMsg}</p>
                                                </div>
                                            </div>
                                        )
                                    })
                                )}
                            </div>
                        )}

                        {view === 'chat' && activeChat && (
                            <ChatWindow 
                                chat={chats.find(c => c.id === activeChat.id) || activeChat} 
                                currentUser={user.uid} 
                                onSend={sendMessage} 
                            />
                        )}

                        {view === 'camera' && (
                            <div className="absolute inset-0 bg-black text-white flex flex-col items-center justify-center p-6 text-center">
                                <div className="w-64 h-64 border-4 border-blue-500 rounded-3xl mb-8 relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-blue-400 shadow-[0_0_20px_rgba(59,130,246,1)] animate-[scan_2s_infinite]"></div>
                                    <div className="w-full h-full bg-white/5 flex items-center justify-center">
                                        <span className="text-6xl opacity-20">üì∑</span>
                                    </div>
                                </div>
                                <h2 className="text-2xl font-bold kid-font mb-2">Escanea el QR de tu amigo</h2>
                                <p className="text-sm opacity-70 mb-8">Debes estar f√≠sicamente con √©l.</p>
                                <button onClick={handleScanQR} className="bg-blue-600 w-full py-4 rounded-xl font-bold text-lg shadow-lg mb-4">Simular Captura</button>
                                <button onClick={() => setView('list')} className="text-white/50">Cancelar</button>
                            </div>
                        )}
                    </div>

                    {/* FAB (Floating Action Button) for Scan */}
                    {view === 'list' && (
                        <div className="absolute bottom-6 w-full flex justify-center pointer-events-none">
                            <button 
                                onClick={() => setView('camera')}
                                className="pointer-events-auto bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-full shadow-2xl flex items-center gap-3 font-bold text-lg transform transition hover:scale-105 active:scale-95 border-4 border-white"
                            >
                                <Icon name="camera" /> A√±adir Amigo
                            </button>
                        </div>
                    )}
                    
                    {/* Mostrar mi propio c√≥digo (mini) */}
                    {view === 'list' && (
                        <div className="absolute bottom-6 right-6 pointer-events-auto">
                             <div className="w-12 h-12 bg-white rounded-xl shadow-md flex items-center justify-center border-2 border-slate-100" onClick={() => alert(`Tu c√≥digo personal: ${userData.familyCode}`)}>
                                <Icon name="qr" size={20} className="text-slate-800"/>
                             </div>
                        </div>
                    )}
                </div>
            );
        };

        const ChatWindow = ({ chat, currentUser, onSend }) => {
            const [txt, setTxt] = useState("");
            const endRef = useRef(null);
            
            useEffect(() => endRef.current?.scrollIntoView({behavior: "smooth"}), [chat.messages]);

            return (
                <div className="flex flex-col h-full">
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {chat.messages.map((m, i) => {
                            const isMe = m.senderId === currentUser;
                            return (
                                <div key={i} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[75%] p-3 rounded-2xl text-sm ${isMe ? 'bg-blue-500 text-white rounded-br-none' : 'bg-white border border-gray-200 rounded-bl-none'}`}>
                                        {m.text}
                                    </div>
                                </div>
                            )
                        })}
                        <div ref={endRef} />
                    </div>
                    <div className="p-3 bg-white border-t border-gray-100 flex gap-2">
                        <input 
                            className="flex-1 bg-gray-100 rounded-full px-4 py-3 outline-none focus:ring-2 focus:ring-blue-200 transition"
                            placeholder="Mensaje..."
                            value={txt}
                            onChange={e => setTxt(e.target.value)}
                            onKeyPress={e => e.key === 'Enter' && (onSend(txt), setTxt(''))}
                        />
                        <button onClick={() => {onSend(txt); setTxt('')}} className="bg-blue-500 text-white p-3 rounded-full shadow-lg hover:bg-blue-600 transition">
                            <Icon name="plus" className="rotate-90" /> {/* Simulate Send icon */}
                        </button>
                    </div>
                </div>
            )
        };

        const Login = ({ onLogin }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [role, setRole] = useState('parent');
            const [form, setForm] = useState({email:'', pass:'', name:''});
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    let user;
                    if (isRegister) {
                        const res = await auth.createUserWithEmailAndPassword(form.email, form.pass);
                        user = res.user;
                        await db.collection(USERS_COLLECTION).doc(user.uid).set({
                            name: form.name,
                            email: form.email,
                            role: role,
                            familyCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                            parentId: null, // For kids
                            dailyLimit: 120, // For kids
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        const res = await auth.signInWithEmailAndPassword(form.email, form.pass);
                        user = res.user;
                    }
                } catch(err) {
                    alert(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="h-full flex items-center justify-center bg-slate-900 text-white p-6">
                    <div className="w-full max-w-md">
                        <div className="text-center mb-10">
                            <div className="inline-block p-4 bg-blue-600 rounded-2xl mb-4 shadow-lg shadow-blue-500/30"><Icon name="shield" size={40} /></div>
                            <h1 className="text-4xl font-bold mb-2">SafeChat</h1>
                            <p className="text-slate-400">Plataforma segura para familias</p>
                        </div>

                        <div className="bg-white/10 backdrop-blur-md p-8 rounded-3xl border border-white/10">
                            <div className="flex mb-6 bg-black/20 p-1 rounded-xl">
                                <button onClick={() => setIsRegister(false)} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${!isRegister ? 'bg-white text-slate-900 shadow' : 'text-slate-400'}`}>Entrar</button>
                                <button onClick={() => setIsRegister(true)} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${isRegister ? 'bg-white text-slate-900 shadow' : 'text-slate-400'}`}>Registrar</button>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                {isRegister && (
                                    <>
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase ml-1">Nombre</label>
                                            <input required className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 mt-1 focus:ring-2 focus:ring-blue-500 outline-none" onChange={e => setForm({...form, name: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase ml-1">Soy...</label>
                                            <div className="grid grid-cols-2 gap-3 mt-1">
                                                <button type="button" onClick={() => setRole('parent')} className={`p-3 rounded-xl border-2 font-bold transition ${role === 'parent' ? 'border-blue-500 bg-blue-500/20 text-blue-400' : 'border-slate-700 text-slate-500 hover:border-slate-500'}`}>Padre</button>
                                                <button type="button" onClick={() => setRole('kid')} className={`p-3 rounded-xl border-2 font-bold transition ${role === 'kid' ? 'border-green-500 bg-green-500/20 text-green-400' : 'border-slate-700 text-slate-500 hover:border-slate-500'}`}>Hijo</button>
                                            </div>
                                        </div>
                                    </>
                                )}
                                <div>
                                    <label className="text-xs font-bold text-slate-400 uppercase ml-1">Email</label>
                                    <input type="email" required className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 mt-1 focus:ring-2 focus:ring-blue-500 outline-none" onChange={e => setForm({...form, email: e.target.value})} />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-400 uppercase ml-1">Contrase√±a</label>
                                    <input type="password" required className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 mt-1 focus:ring-2 focus:ring-blue-500 outline-none" onChange={e => setForm({...form, pass: e.target.value})} />
                                </div>
                                <button disabled={loading} className="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-600/20 mt-4 transition">
                                    {loading ? 'Procesando...' : (isRegister ? 'Crear Cuenta' : 'Iniciar Sesi√≥n')}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            )
        }

        const App = () => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async u => {
                    if(u) {
                        try {
                            const doc = await db.collection(USERS_COLLECTION).doc(u.uid).get();
                            if(doc.exists) {
                                setUserData(doc.data());
                                setUser(u);
                            }
                        } catch(e) { console.error(e); }
                    } else {
                        setUser(null);
                        setUserData(null);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            if(loading) return <div className="h-full flex items-center justify-center bg-slate-900 text-white">Cargando SafeChat...</div>;

            if(!user) return <Login />;

            if(userData.role === 'parent') return <ParentDashboard user={user} userData={userData} />;
            return <KidApp user={user} userData={userData} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
