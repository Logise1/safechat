<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SafeChat Pro - Vanilla JS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">

    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                        kid: { 100: '#fef3c7', 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        kid: ['Fredoka', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Reset y Full Screen Real */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Evita scroll en el body */
            background-color: #f8fafc;
            touch-action: manipulation;
        }
        #app {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        /* Utilidades */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .sos-pulse { animation: sos 1.5s infinite; }
        @keyframes sos { 
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 
        }
        .message-bubble-me { border-top-right-radius: 0; }
        .message-bubble-other { border-top-left-radius: 0; }
        
        /* Animaciones */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <!-- Contenedor Principal -->
    <div id="app">
        <!-- Pantalla de Carga Inicial -->
        <div id="loading" class="h-full w-full flex items-center justify-center bg-slate-900 text-white font-bold tracking-widest z-50 fixed top-0 left-0">
            CARGANDO SISTEMA...
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN E INICIALIZACI√ìN ---
        const firebaseConfig = {
            apiKey: "AIzaSyC1XbhA7TTz7gn-3_SFJ53p7DPfq36eRdg",
            authDomain: "safechat-224e2.firebaseapp.com",
            projectId: "safechat-224e2",
            storageBucket: "safechat-224e2.firebasestorage.app",
            messagingSenderId: "390500687585",
            appId: "1:390500687585:web:36fc0ce72b58e02351e1a0",
            measurementId: "G-C7TZK5P9W6"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = 'safechat-pro-v3-vanilla'; 
        
        const COLLECTIONS = {
            USERS: `artifacts/${APP_ID}/public/data/users`,
            CHATS: `artifacts/${APP_ID}/public/data/chats`,
            ALERTS: `artifacts/${APP_ID}/public/data/alerts`
        };

        const BAD_WORDS = ["tonto", "estupido", "idiota", "matar", "odio", "feo", "gordo"];
        const AVATARS = ["ü¶Å", "ü¶ä", "üêº", "üê®", "üêØ", "ü¶Ñ", "ü¶ï", "üêô", "üöÄ", "‚≠ê"];

        // --- 2. SISTEMA DE UI (MODALES Y TOASTS) ---
        // Reemplaza alert(), confirm(), prompt() nativos
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            toast.className = `fixed top-4 right-4 ${colors} text-white px-6 py-4 rounded-xl shadow-2xl z-[100] font-bold text-sm transform transition-all duration-300 slide-up flex items-center gap-3`;
            toast.innerHTML = `
                <span>${type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-4');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showModal({ title, text, inputPlaceholder, onConfirm, confirmText = 'Aceptar', confirmColor = 'bg-brand-600' }) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] flex items-center justify-center p-4 fade-in';
            
            let inputHtml = '';
            if (inputPlaceholder) {
                inputHtml = `<input id="modal-input" class="w-full bg-slate-100 border border-slate-200 rounded-xl p-4 mt-4 focus:ring-2 focus:ring-brand-500 outline-none text-slate-800" placeholder="${inputPlaceholder}" autocomplete="off">`;
            }

            overlay.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100 slide-up">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-2">${title}</h3>
                        <p class="text-slate-500 text-sm leading-relaxed">${text}</p>
                        ${inputHtml}
                    </div>
                    <div class="bg-slate-50 p-4 flex gap-3">
                        <button id="modal-cancel" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-200 rounded-xl transition">Cancelar</button>
                        <button id="modal-confirm" class="flex-1 py-3 ${confirmColor} text-white font-bold rounded-xl shadow-lg hover:opacity-90 transition">${confirmText}</button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            const input = overlay.querySelector('#modal-input');
            const close = () => overlay.remove();

            if (input) setTimeout(() => input.focus(), 100);

            overlay.querySelector('#modal-cancel').onclick = close;
            overlay.querySelector('#modal-confirm').onclick = () => {
                const val = input ? input.value.trim() : true;
                if (input && !val) return input.focus();
                onConfirm(val);
                close();
            };
            
            if (input) {
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') overlay.querySelector('#modal-confirm').click();
                };
            }
        }

        // --- 3. ESTADO GLOBAL ---
        const state = {
            user: null, userData: null, view: 'loading',
            kids: [], alerts: [], chats: [],
            selectedKid: null, activeChat: null,
            unsubscribes: [], profileUnsub: null
        };

        // --- 4. ICONOS SVG ---
        const icons = {
            shield: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
            users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            lock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
            unlock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>`,
            home: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            chat: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
            send: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`,
            camera: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>`,
            qr: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><path d="M3 14h1v1H3z"/><path d="M5 14h1v1H5z"/><path d="M3 16h1v1H3z"/><path d="M5 16h1v1H5z"/><path d="M7 14h1v1H7z"/><path d="M9 14h1v1H9z"/><path d="M7 16h1v1H7z"/><path d="M9 16h1v1H9z"/><path d="M7 18h1v1H7z"/><path d="M9 18h1v1H9z"/></svg>`,
            logout: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`,
            sos: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
            back: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>`
        };

        const appDiv = document.getElementById('app');

        function cleanListeners() {
            state.unsubscribes.forEach(u => u());
            state.unsubscribes = [];
        }

        // --- VISTA: AUTENTICACI√ìN ---
        function renderAuth() {
            let isRegister = false;
            let role = 'parent';
            let selectedAvatar = AVATARS[0];

            const renderForm = () => {
                appDiv.innerHTML = `
                    <div class="h-full w-full flex items-center justify-center bg-slate-900 p-6 relative overflow-hidden fade-in">
                         <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                         <div class="bg-white/10 backdrop-blur-xl p-8 rounded-3xl w-full max-w-md border border-white/20 shadow-2xl relative z-10">
                            <div class="text-center mb-8">
                                <div class="w-16 h-16 bg-gradient-to-tr from-brand-500 to-kid-400 rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-4 text-white">
                                    ${icons.shield}
                                </div>
                                <h1 class="text-3xl font-bold text-white mb-1">SafeChat Pro</h1>
                                <p class="text-slate-400 text-sm">Plataforma Segura V3.0 - Vanilla JS</p>
                            </div>

                            <div class="flex bg-black/20 p-1 rounded-xl mb-6">
                                <button id="btn-login-mode" class="flex-1 py-2 rounded-lg text-sm font-bold transition ${!isRegister ? 'bg-white text-slate-900 shadow' : 'text-slate-400'}">Entrar</button>
                                <button id="btn-register-mode" class="flex-1 py-2 rounded-lg text-sm font-bold transition ${isRegister ? 'bg-white text-slate-900 shadow' : 'text-slate-400'}">Registrar</button>
                            </div>

                            <form id="auth-form" class="space-y-4">
                                ${isRegister ? `
                                    <div class="grid grid-cols-2 gap-3">
                                        <button type="button" class="btn-role p-3 rounded-xl border-2 font-bold text-sm transition ${role==='parent'?'border-brand-500 bg-brand-500/20 text-brand-300':'border-slate-700 text-slate-500'}" data-role="parent">Soy Padre</button>
                                        <button type="button" class="btn-role p-3 rounded-xl border-2 font-bold text-sm transition ${role==='kid'?'border-kid-500 bg-kid-500/20 text-kid-300':'border-slate-700 text-slate-500'}" data-role="kid">Soy Ni√±o</button>
                                    </div>
                                    <input id="input-name" placeholder="Nombre Completo" required class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white focus:border-brand-500 outline-none transition">
                                    ${role === 'kid' ? `
                                        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide" id="avatar-list">
                                            ${AVATARS.map(a => `<button type="button" class="btn-avatar text-2xl p-2 rounded-lg transition ${selectedAvatar === a ? 'bg-white/20 scale-110' : 'opacity-50'}" data-av="${a}">${a}</button>`).join('')}
                                        </div>
                                    ` : ''}
                                ` : ''}
                                <input id="input-email" type="email" placeholder="Correo Electr√≥nico" required class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white focus:border-brand-500 outline-none transition">
                                <input id="input-pass" type="password" placeholder="Contrase√±a" required class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white focus:border-brand-500 outline-none transition">
                                <button type="submit" id="btn-submit" class="w-full bg-gradient-to-r from-brand-600 to-brand-500 text-white font-bold py-4 rounded-xl shadow-lg hover:scale-[1.02] transition">
                                    ${isRegister ? 'Crear Cuenta' : 'Iniciar Sesi√≥n'}
                                </button>
                            </form>
                         </div>
                    </div>
                `;

                // Listeners
                document.getElementById('btn-login-mode').onclick = () => { isRegister = false; renderForm(); };
                document.getElementById('btn-register-mode').onclick = () => { isRegister = true; renderForm(); };
                
                document.querySelectorAll('.btn-role').forEach(btn => {
                    btn.onclick = (e) => { role = e.target.dataset.role; renderForm(); }
                });

                document.querySelectorAll('.btn-avatar').forEach(btn => {
                    btn.onclick = (e) => { selectedAvatar = e.target.dataset.av; renderForm(); }
                });

                document.getElementById('auth-form').onsubmit = async (e) => {
                    e.preventDefault();
                    
                    const btn = document.getElementById('btn-submit');
                    const originalText = btn.innerText;
                    btn.innerText = "Procesando...";
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');

                    const email = document.getElementById('input-email').value;
                    const pass = document.getElementById('input-pass').value;
                    
                    try {
                        if(isRegister) {
                            const name = document.getElementById('input-name').value;
                            const r = await auth.createUserWithEmailAndPassword(email, pass);
                            await db.collection(COLLECTIONS.USERS).doc(r.user.uid).set({
                                name, email, role, 
                                avatar: role === 'kid' ? selectedAvatar : 'üë§',
                                familyCode: Math.random().toString(36).substring(2,8).toUpperCase(),
                                parentId: null, isLocked: false, createdAt: new Date().toISOString()
                            });
                        } else {
                            await auth.signInWithEmailAndPassword(email, pass);
                        }
                    } catch(err) {
                        showToast(err.message, 'error');
                        btn.innerText = originalText;
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                };
            };
            renderForm();
        }

        // --- VISTA: PADRE ---
        function renderParentDashboard() {
            cleanListeners();
            
            // Kids Listener
            state.unsubscribes.push(
                db.collection(COLLECTIONS.USERS).where('parentId', '==', state.user.uid)
                .onSnapshot(snap => {
                    state.kids = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    refreshParentView();
                })
            );

            // Alerts Listener
            state.unsubscribes.push(
                db.collection(COLLECTIONS.ALERTS).where('parentId', '==', state.user.uid).orderBy('timestamp', 'desc').limit(20)
                .onSnapshot(snap => {
                    state.alerts = snap.docs.map(d => d.data());
                    refreshParentView();
                })
            );

            appDiv.innerHTML = `
                <div class="flex h-full bg-slate-50 font-sans">
                    <div class="w-16 md:w-64 bg-slate-900 text-slate-300 flex flex-col py-6 shadow-2xl z-20 flex-shrink-0">
                        <div class="px-4 mb-8 flex items-center justify-center md:justify-start gap-3 text-white">
                            <div class="bg-brand-600 p-2 rounded-lg"><div class="w-5 h-5">${icons.shield}</div></div>
                            <span class="font-bold text-lg hidden md:block">SafeChat Pro</span>
                        </div>
                        <nav class="flex-1 space-y-2 px-2" id="parent-nav"></nav>
                        <div class="px-4 pt-4 border-t border-slate-800">
                            <button id="btn-logout" class="flex items-center gap-2 hover:text-white transition w-full justify-center md:justify-start">
                                <div class="w-5 h-5">${icons.logout}</div> <span class="hidden md:block">Salir</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col h-full overflow-hidden relative">
                        <header class="bg-white h-16 border-b flex items-center justify-between px-6 shadow-sm flex-shrink-0">
                            <h2 class="text-xl font-bold text-slate-800" id="header-title">Resumen</h2>
                            <div class="flex items-center gap-3">
                                <div class="text-right hidden sm:block">
                                    <div class="text-sm font-bold text-slate-800">${state.userData.name}</div>
                                    <div class="text-xs text-slate-500">Admin</div>
                                </div>
                                <div class="w-10 h-10 bg-brand-100 rounded-full flex items-center justify-center text-brand-600 font-bold border-2 border-brand-200">${state.userData.name[0]}</div>
                            </div>
                        </header>
                        <main id="parent-content" class="flex-1 overflow-y-auto p-4 md:p-8"></main>
                    </div>
                </div>
            `;

            document.getElementById('btn-logout').onclick = () => auth.signOut();
            refreshParentView();
        }

        function refreshParentView() {
            const nav = document.getElementById('parent-nav');
            if(!nav) return;

            nav.innerHTML = `
                <button onclick="switchParentView('overview')" class="w-full flex items-center gap-3 p-3 rounded-xl transition-all ${!state.selectedKid && state.view === 'parent_overview' ? 'bg-brand-600 text-white' : 'hover:bg-slate-800'}">
                    <div class="w-5 h-5">${icons.home}</div> <span class="hidden md:block font-medium">Panel General</span>
                </button>
                <div class="pt-4 pb-2 px-2 text-xs font-bold uppercase text-slate-500 hidden md:block">Dispositivos</div>
                ${state.kids.map(kid => `
                    <button onclick="selectKid('${kid.id}')" class="w-full flex items-center gap-3 p-3 rounded-xl transition-all ${state.selectedKid?.id === kid.id ? 'bg-slate-800 text-white border-l-4 border-brand-500' : 'hover:bg-slate-800'}">
                        <span class="text-xl">${kid.avatar || 'üë§'}</span> 
                        <div class="hidden md:block text-left overflow-hidden w-full">
                            <div class="truncate font-medium">${kid.name}</div>
                            <div class="text-[10px] flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full ${kid.isLocked ? 'bg-red-500' : 'bg-green-500'}"></span>
                                ${kid.isLocked ? 'Bloqueado' : 'Activo'}
                            </div>
                        </div>
                    </button>
                `).join('')}
                <button onclick="addKidPrompt()" class="w-full mt-2 border border-slate-700 border-dashed p-3 rounded-xl hover:border-brand-500 hover:text-brand-500 transition flex justify-center md:justify-start gap-3 text-slate-400">
                    <div class="w-5 h-5">${icons.users}</div> <span class="hidden md:block">Vincular</span>
                </button>
            `;

            const content = document.getElementById('parent-content');
            const title = document.getElementById('header-title');

            if (state.selectedKid) {
                title.textContent = `Gestionando a ${state.selectedKid.name}`;
                content.innerHTML = `
                    <div class="max-w-4xl mx-auto space-y-6 fade-in">
                        <div class="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                            <div class="p-8 bg-gradient-to-r from-slate-900 to-slate-800 text-white flex flex-col md:flex-row justify-between items-center gap-4">
                                <div class="flex items-center gap-4">
                                    <div class="text-6xl">${state.selectedKid.avatar}</div>
                                    <div>
                                        <h1 class="text-3xl font-bold">${state.selectedKid.name}</h1>
                                        <div class="text-sm opacity-80 mt-1 font-mono">CODE: ${state.selectedKid.familyCode}</div>
                                    </div>
                                </div>
                                <button onclick="toggleLock('${state.selectedKid.id}', ${state.selectedKid.isLocked})" 
                                    class="px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition shadow-xl ${state.selectedKid.isLocked ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}">
                                    <div class="w-5 h-5">${state.selectedKid.isLocked ? icons.unlock : icons.lock}</div>
                                    ${state.selectedKid.isLocked ? "DESBLOQUEAR" : "BLOQUEAR"}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                title.textContent = "Resumen de Seguridad";
                content.innerHTML = `
                    <div class="max-w-5xl mx-auto space-y-8 fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <div class="text-slate-500 text-sm font-medium mb-1">Activos</div>
                                <div class="text-4xl font-bold text-slate-800">${state.kids.filter(k => !k.isLocked).length}/${state.kids.length}</div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <div class="text-slate-500 text-sm font-medium mb-1">Alertas Hoy</div>
                                <div class="text-4xl font-bold text-red-500">${state.alerts.length}</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                                <h3 class="font-bold text-slate-800">Alertas Recientes</h3>
                            </div>
                            <div class="divide-y divide-slate-50">
                                ${state.alerts.length === 0 ? '<div class="p-8 text-center text-slate-400">Sin incidentes.</div>' : 
                                  state.alerts.map(alert => `
                                    <div class="p-4 flex items-center gap-4 hover:bg-slate-50 transition">
                                        <div class="p-2 rounded-lg ${alert.type === 'SOS' ? 'bg-red-100 text-red-600' : 'bg-orange-100 text-orange-600'}">
                                            <div class="w-6 h-6">${icons.shield}</div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-bold text-sm text-slate-800">${alert.type === 'SOS' ? 'SOS RECIBIDO' : 'LENGUAJE BLOQUEADO'}</div>
                                            <div class="text-xs text-slate-500">Usuario: ${alert.kidName} ‚Ä¢ "${alert.detail}"</div>
                                        </div>
                                        <div class="text-xs text-slate-400 font-mono">
                                            ${alert.timestamp ? new Date(alert.timestamp.toDate()).toLocaleTimeString() : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Global functions for Parent UI
        window.switchParentView = (v) => { state.selectedKid = null; state.view = 'parent_overview'; refreshParentView(); }
        window.selectKid = (id) => { state.selectedKid = state.kids.find(k => k.id === id); refreshParentView(); }
        window.addKidPrompt = () => {
            showModal({
                title: 'Vincular Dispositivo',
                text: 'Introduce el c√≥digo de 6 caracteres que aparece en la pantalla del ni√±o.',
                inputPlaceholder: 'C√ìDIGO (Ej: A1B2C3)',
                confirmText: 'Vincular',
                onConfirm: async (code) => {
                    if(!code) return;
                    try {
                        const snap = await db.collection(COLLECTIONS.USERS).where('familyCode', '==', code.toUpperCase()).get();
                        if(snap.empty) return showToast("C√≥digo no v√°lido", 'error');
                        const kid = snap.docs[0];
                        if(kid.data().role !== 'kid') return showToast("C√≥digo incorrecto (no es ni√±o)", 'error');
                        await db.collection(COLLECTIONS.USERS).doc(kid.id).update({ parentId: state.user.uid });
                        showToast("Dispositivo vinculado correctamente");
                    } catch(e) { console.error(e); showToast(e.message, 'error'); }
                }
            });
        }
        window.toggleLock = async (id, currentStatus) => {
            await db.collection(COLLECTIONS.USERS).doc(id).update({ isLocked: !currentStatus });
        }

        // --- VISTA: NI√ëO ---
        function renderKidApp() {
            if (state.userData.isLocked) {
                appDiv.innerHTML = `
                    <div class="h-full bg-slate-900 text-white flex flex-col items-center justify-center p-8 text-center fade-in">
                        <div class="mb-6 p-6 bg-slate-800 rounded-full shadow-2xl text-red-500 w-24 h-24 flex items-center justify-center">${icons.lock}</div>
                        <h1 class="text-3xl font-bold mb-2">Pausa</h1>
                        <p class="text-slate-400 mb-8">Dispositivo bloqueado por tus padres.</p>
                    </div>
                `;
                return;
            }

            if (!state.userData.parentId) {
                appDiv.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-b from-kid-400 to-kid-500 text-white text-center fade-in">
                        <div class="bg-white/20 p-4 rounded-full mb-6 w-20 h-20 flex items-center justify-center">${icons.shield}</div>
                        <h1 class="text-3xl font-kid font-bold mb-2">¬°Casi listo!</h1>
                        <p class="mb-8 opacity-90">Pide a tus padres que usen este c√≥digo:</p>
                        <div class="bg-white text-slate-900 text-4xl font-mono font-bold p-6 rounded-2xl shadow-xl border-4 border-white/50 tracking-widest">
                            ${state.userData.familyCode}
                        </div>
                        <button id="btn-logout-kid" class="mt-12 text-white/70 font-bold">Salir</button>
                    </div>
                `;
                document.getElementById('btn-logout-kid').onclick = () => auth.signOut();
                return;
            }

            cleanListeners();
            state.unsubscribes.push(
                db.collection(COLLECTIONS.CHATS).where('participants', 'array-contains', state.user.uid)
                .onSnapshot(snap => {
                    state.chats = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    refreshKidView();
                })
            );
            
            appDiv.innerHTML = `
                <div class="h-full flex flex-col bg-white max-w-md mx-auto shadow-2xl relative font-kid">
                    <div class="bg-kid-400 p-4 pb-6 rounded-b-[30px] shadow-lg z-10 relative overflow-hidden flex-shrink-0">
                        <div class="flex justify-between items-center relative z-10">
                            <div class="flex items-center gap-3">
                                <div class="text-4xl bg-white rounded-full p-1 shadow-sm border-2 border-kid-200">${state.userData.avatar}</div>
                                <div>
                                    <h1 class="font-bold text-xl text-white drop-shadow-sm">${state.userData.name}</h1>
                                </div>
                            </div>
                            <button onclick="sendSOS()" class="bg-red-500 text-white w-12 h-12 flex items-center justify-center rounded-full shadow-lg border-4 border-white/30 sos-pulse active:scale-95 transition">
                                <div class="w-6 h-6">${icons.sos}</div>
                            </button>
                        </div>
                    </div>
                    <div id="kid-content" class="flex-1 overflow-y-auto bg-slate-50 relative pb-20"></div>
                    <div id="kid-nav" class="absolute bottom-6 left-0 right-0 flex justify-center gap-4 pointer-events-none z-20"></div>
                </div>
            `;
            refreshKidView();
        }

        function refreshKidView() {
            const content = document.getElementById('kid-content');
            const nav = document.getElementById('kid-nav');
            if (!content) return;

            if (state.activeChat) {
                nav.innerHTML = '';
                const msgs = state.activeChat.messages || [];
                content.innerHTML = `
                    <div class="flex flex-col h-full bg-white font-sans">
                        <div class="p-3 border-b flex items-center gap-3 bg-white sticky top-0 z-20 shadow-sm">
                            <button onclick="closeChat()" class="p-2 bg-slate-100 rounded-full w-10 h-10 flex items-center justify-center text-slate-600 hover:bg-slate-200">${icons.back}</button>
                            <span class="font-bold text-lg flex-1">Chat</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50" id="msg-container">
                            ${msgs.map(m => `
                                <div class="flex ${m.senderId === state.user.uid ? 'justify-end' : 'justify-start'}">
                                    <div class="max-w-[80%] p-3 rounded-2xl text-sm ${m.senderId === state.user.uid ? 'bg-kid-500 text-white message-bubble-me shadow-md' : 'bg-white border border-slate-200 message-bubble-other'}">
                                        ${m.text}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="p-3 border-t bg-white flex gap-2">
                            <input id="msg-input" class="flex-1 bg-slate-100 rounded-full px-4 outline-none border-2 border-transparent focus:border-kid-300 transition" placeholder="Escribe..." autocomplete="off">
                            <button onclick="sendMessage()" class="bg-kid-500 text-white w-12 h-12 flex items-center justify-center rounded-full shadow-lg hover:bg-kid-600 transition">${icons.send}</button>
                        </div>
                    </div>
                `;
                const container = document.getElementById('msg-container');
                container.scrollTop = container.scrollHeight;
                document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
            } else {
                content.innerHTML = `
                    <div class="p-4 space-y-4">
                        ${state.chats.length === 0 ? `
                            <div class="text-center py-20 opacity-50">
                                <div class="text-6xl mb-4 grayscale">ü¶ï</div>
                                <p class="font-kid text-xl text-slate-400">¬°A√±ade amigos!</p>
                            </div>
                        ` : state.chats.map(chat => {
                            const otherId = chat.participants.find(p => p !== state.user.uid);
                            const name = chat.names?.[otherId] || 'Amigo';
                            const avatar = chat.avatars?.[otherId] || 'üôÇ';
                            const lastMsg = chat.messages[chat.messages.length-1]?.text || "¬°Saluda!";
                            return `
                                <div onclick="openChat('${chat.id}')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 active:scale-95 transition cursor-pointer">
                                    <div class="text-3xl bg-slate-100 w-12 h-12 flex items-center justify-center rounded-full">${avatar}</div>
                                    <div class="flex-1 min-w-0">
                                        <h3 class="font-bold text-slate-800 font-kid text-lg">${name}</h3>
                                        <p class="text-slate-400 text-sm truncate font-sans">${lastMsg}</p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                nav.innerHTML = `
                    <button onclick="scanFriend()" class="pointer-events-auto bg-brand-600 text-white px-6 py-4 rounded-full shadow-2xl flex items-center gap-2 font-bold transform hover:scale-105 transition border-4 border-white font-sans">
                        <div class="w-5 h-5">${icons.camera}</div> A√±adir Amigo
                    </button>
                `;
            }
        }

        // Global functions for Kid UI
        window.sendSOS = () => {
            showModal({
                title: '¬øEMERGENCIA?',
                text: 'Esto enviar√° una alerta inmediata a tus padres.',
                confirmText: 'S√ç, ENVIAR AYUDA',
                confirmColor: 'bg-red-600',
                onConfirm: async () => {
                    try {
                        await db.collection(COLLECTIONS.ALERTS).add({
                            type: 'SOS',
                            kidId: state.user.uid,
                            kidName: state.userData.name,
                            parentId: state.userData.parentId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            detail: "BOT√ìN DE P√ÅNICO PRESIONADO"
                        });
                        showToast("üö® ALERTA ENVIADA");
                    } catch(e) { console.error(e); }
                }
            });
        }

        window.scanFriend = () => {
            showModal({
                title: 'A√±adir Amigo',
                text: 'Pide a tu amigo que te diga su c√≥digo personal.',
                inputPlaceholder: 'C√ìDIGO DE AMIGO',
                confirmText: 'Buscar',
                onConfirm: async (code) => {
                    if(!code) return;
                    try {
                        const snap = await db.collection(COLLECTIONS.USERS).where('familyCode', '==', code.toUpperCase()).get();
                        if(snap.empty) return showToast("C√≥digo no encontrado", 'error');
                        const friend = snap.docs[0].data();
                        if(friend.role !== 'kid') return showToast("Solo puedes a√±adir a otros ni√±os", 'error');
                        
                        await db.collection(COLLECTIONS.CHATS).add({
                            participants: [state.user.uid, snap.docs[0].id],
                            names: { [state.user.uid]: state.userData.name, [snap.docs[0].id]: friend.name },
                            avatars: { [state.user.uid]: state.userData.avatar, [snap.docs[0].id]: friend.avatar },
                            messages: [],
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showToast("¬°Amigo a√±adido!");
                    } catch(e) { console.error(e); showToast(e.message, 'error'); }
                }
            });
        }

        window.openChat = (id) => { state.activeChat = state.chats.find(c => c.id === id); refreshKidView(); }
        window.closeChat = () => { state.activeChat = null; refreshKidView(); }

        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            const hasBadWord = BAD_WORDS.some(word => text.toLowerCase().includes(word));
            if(hasBadWord) {
                input.value = "";
                await db.collection(COLLECTIONS.ALERTS).add({
                    type: 'BAD_WORD',
                    kidId: state.user.uid,
                    kidName: state.userData.name,
                    parentId: state.userData.parentId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    detail: text
                });
                return showToast("‚ö†Ô∏è Mensaje bloqueado. S√© amable.", 'error');
            }

            try {
                await db.collection(COLLECTIONS.CHATS).doc(state.activeChat.id).update({
                    messages: firebase.firestore.FieldValue.arrayUnion({
                        text, 
                        senderId: state.user.uid, 
                        timestamp: new Date().toISOString()
                    }),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                input.value = "";
            } catch(e) { console.error(e); }
        }

        // --- ORQUESTADOR PRINCIPAL ---
        auth.onAuthStateChanged(async (u) => {
            if (u) {
                if(state.profileUnsub) state.profileUnsub();
                state.profileUnsub = db.collection(COLLECTIONS.USERS).doc(u.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        state.user = u;
                        state.userData = doc.data();
                        state.userData.role === 'parent' ? renderParentDashboard() : renderKidApp();
                    } else {
                         console.warn("Esperando perfil...");
                    }
                }, error => {
                    console.error(error);
                    showToast("Error de acceso a datos", 'error');
                    auth.signOut();
                });
            } else {
                state.user = null;
                state.userData = null;
                if(state.profileUnsub) state.profileUnsub();
                cleanListeners();
                renderAuth();
            }
        });

    </script>
</body>
</html>
