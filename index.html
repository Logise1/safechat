<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeChat - Para Niños y Padres</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- QRCode Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #E0F2FE; /* Sky Blue 100 */
        }
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            z-index: -1;
            opacity: 0.5;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 3px;
        }
        .message-bubble {
            max-width: 75%;
            word-wrap: break-word;
        }
        #qr-reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
        }
        .animate-pulse-fast {
            animation: pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-blue-50 h-screen overflow-hidden flex flex-col items-center justify-center relative">

    <!-- Background Decoration -->
    <div class="blob bg-purple-300 w-64 h-64 top-0 left-0 mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
    <div class="blob bg-yellow-300 w-64 h-64 bottom-0 right-0 mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>

    <!-- App Container -->
    <div id="app" class="w-full max-w-md h-full sm:h-[90vh] bg-white sm:rounded-3xl shadow-2xl overflow-hidden flex flex-col relative">
        
        <!-- HEADER -->
        <header class="bg-indigo-600 text-white p-4 shadow-md flex justify-between items-center z-10">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-shield-cat text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wide">SafeChat</h1>
            </div>
            <button id="logoutBtn" class="hidden text-sm bg-indigo-800 px-3 py-1 rounded-full hover:bg-indigo-700 transition">
                <i class="fa-solid fa-right-from-bracket"></i> Salir
            </button>
        </header>

        <!-- CONTENT AREA -->
        <main id="mainContent" class="flex-1 overflow-y-auto relative">
            <!-- Views will be injected here -->
            <div id="loading" class="flex flex-col items-center justify-center h-full">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-indigo-500 mb-2"></i>
                <p class="text-gray-500">Conectando seguro...</p>
            </div>
        </main>

        <!-- TOAST NOTIFICATION -->
        <div id="toast" class="absolute bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50 text-sm text-center w-max max-w-[90%]">
            Notification
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, getDoc, setDoc, updateDoc, orderBy, serverTimestamp, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC1XbhA7TTz7gn-3_SFJ53p7DPfq36eRdg",
            authDomain: "safechat-224e2.firebaseapp.com",
            projectId: "safechat-224e2",
            storageBucket: "safechat-224e2.firebasestorage.app",
            messagingSenderId: "390500687585",
            appId: "1:390500687585:web:36fc0ce72b58e02351e1a0",
            measurementId: "G-C7TZK5P9W6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE & UTILS ---
        let currentUser = null;
        let userData = null;
        let unsubscribeChats = null;
        let unsubscribeMessages = null;
        let qrInterval = null;
        let html5QrcodeScanner = null;

        const mainContent = document.getElementById('mainContent');
        const logoutBtn = document.getElementById('logoutBtn');
        const toastEl = document.getElementById('toast');

        function showToast(msg, isError = false) {
            toastEl.innerText = msg;
            toastEl.className = `absolute bottom-5 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 z-50 text-sm text-center w-max max-w-[90%] ${isError ? 'bg-red-500 text-white' : 'bg-green-600 text-white'}`;
            toastEl.style.opacity = '1';
            setTimeout(() => { toastEl.style.opacity = '0'; }, 3000);
        }

        function generateLinkCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // --- VIEWS ---

        // 1. AUTH VIEW
        function renderAuth() {
            logoutBtn.classList.add('hidden');
            mainContent.innerHTML = `
                <div class="p-8 flex flex-col h-full justify-center">
                    <div class="text-center mb-6">
                        <div class="inline-block p-4 rounded-full bg-indigo-100 mb-4">
                            <i class="fa-solid fa-users text-4xl text-indigo-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">Bienvenido</h2>
                        <p class="text-gray-500 text-sm">El chat seguro para la familia</p>
                    </div>

                    <div class="bg-white p-1 rounded-lg border flex mb-6">
                        <button id="tab-login" class="flex-1 py-2 rounded-md bg-indigo-600 text-white font-medium text-sm transition">Iniciar Sesión</button>
                        <button id="tab-register" class="flex-1 py-2 rounded-md text-gray-500 font-medium text-sm transition hover:bg-gray-50">Registrarse</button>
                    </div>

                    <form id="authForm" class="space-y-4">
                        <div id="nameField" class="hidden">
                            <label class="block text-xs font-bold text-gray-700 uppercase">Nombre</label>
                            <input type="text" id="inputName" class="w-full mt-1 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Tu nombre">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase">Email</label>
                            <input type="email" id="inputEmail" class="w-full mt-1 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="correo@ejemplo.com" required>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase">Contraseña</label>
                            <input type="password" id="inputPassword" class="w-full mt-1 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="******" required>
                        </div>

                        <div id="roleField" class="hidden space-y-2">
                            <label class="block text-xs font-bold text-gray-700 uppercase">Soy...</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer border p-3 rounded-lg flex-1 hover:bg-blue-50 has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500 transition">
                                    <input type="radio" name="role" value="child" class="w-4 h-4 text-indigo-600" checked>
                                    <div>
                                        <div class="font-bold text-sm">Hijo/a</div>
                                        <div class="text-xs text-gray-500">Quiero chatear</div>
                                    </div>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer border p-3 rounded-lg flex-1 hover:bg-green-50 has-[:checked]:bg-green-100 has-[:checked]:border-green-500 transition">
                                    <input type="radio" name="role" value="parent" class="w-4 h-4 text-green-600">
                                    <div>
                                        <div class="font-bold text-sm">Padre/Madre</div>
                                        <div class="text-xs text-gray-500">Quiero supervisar</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-indigo-700 transition transform active:scale-95">
                            Entrar
                        </button>
                    </form>
                </div>
            `;

            let isLogin = true;
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');
            const nameField = document.getElementById('nameField');
            const roleField = document.getElementById('roleField');
            const btn = document.getElementById('submitBtn');

            function toggleMode(login) {
                isLogin = login;
                if (isLogin) {
                    tabLogin.className = "flex-1 py-2 rounded-md bg-indigo-600 text-white font-medium text-sm transition";
                    tabRegister.className = "flex-1 py-2 rounded-md text-gray-500 font-medium text-sm transition hover:bg-gray-50";
                    nameField.classList.add('hidden');
                    roleField.classList.add('hidden');
                    btn.innerText = "Entrar";
                } else {
                    tabRegister.className = "flex-1 py-2 rounded-md bg-indigo-600 text-white font-medium text-sm transition";
                    tabLogin.className = "flex-1 py-2 rounded-md text-gray-500 font-medium text-sm transition hover:bg-gray-50";
                    nameField.classList.remove('hidden');
                    roleField.classList.remove('hidden');
                    btn.innerText = "Crear Cuenta";
                }
            }

            tabLogin.onclick = () => toggleMode(true);
            tabRegister.onclick = () => toggleMode(false);

            document.getElementById('authForm').onsubmit = async (e) => {
                e.preventDefault();
                const email = document.getElementById('inputEmail').value;
                const password = document.getElementById('inputPassword').value;
                const name = document.getElementById('inputName').value;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                    
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        const role = document.querySelector('input[name="role"]:checked').value;
                        const userCred = await createUserWithEmailAndPassword(auth, email, password);
                        
                        // Setup User Doc
                        const linkCode = role === 'child' ? generateLinkCode() : null;
                        
                        await setDoc(doc(db, "users", userCred.user.uid), {
                            name: name,
                            email: email,
                            role: role,
                            uid: userCred.user.uid,
                            linkCode: linkCode,
                            linkedTo: null, // parentId or childId
                            createdAt: serverTimestamp()
                        });
                        
                        await updateProfile(userCred.user, { displayName: name });
                    }
                } catch (error) {
                    showToast(error.message, true);
                    btn.disabled = false;
                    btn.innerText = isLogin ? "Entrar" : "Crear Cuenta";
                }
            };
        }

        // 2. PARENT DASHBOARD
        function renderParentDashboard() {
            // Check if linked to child
            if (!userData.linkedTo) {
                mainContent.innerHTML = `
                    <div class="p-8 flex flex-col items-center justify-center h-full text-center">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fa-solid fa-child-reaching text-4xl text-green-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Vincular a tu Hijo</h2>
                        <p class="text-gray-600 mb-6 text-sm">Para supervisar, necesitas el código de 6 caracteres que aparece en el perfil de tu hijo.</p>
                        
                        <input type="text" id="childCodeInput" class="text-center text-2xl tracking-widest uppercase w-full max-w-[200px] p-2 border-2 border-green-200 rounded-lg focus:border-green-500 outline-none mb-4" maxlength="6" placeholder="A1B2C3">
                        
                        <button id="linkChildBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-green-700 w-full max-w-[200px]">
                            Vincular
                        </button>
                    </div>
                `;

                document.getElementById('linkChildBtn').onclick = async () => {
                    const code = document.getElementById('childCodeInput').value.toUpperCase();
                    if (code.length < 6) return showToast("Código incompleto", true);

                    const q = query(collection(db, "users"), where("linkCode", "==", code), where("role", "==", "child"));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        showToast("Código inválido", true);
                    } else {
                        const childDoc = querySnapshot.docs[0];
                        // Link logic
                        await updateDoc(doc(db, "users", currentUser.uid), { linkedTo: childDoc.id });
                        await updateDoc(doc(db, "users", childDoc.id), { linkedTo: currentUser.uid });
                        // Refresh will handle by onSnapshot or manual reload
                        window.location.reload(); 
                    }
                };
                return;
            }

            // Monitor View
            mainContent.innerHTML = `
                <div class="flex flex-col h-full bg-gray-50">
                    <div class="bg-green-600 p-4 text-white shadow-md">
                        <h2 class="font-bold"><i class="fa-solid fa-eye mr-2"></i>Modo Supervisor</h2>
                        <p class="text-xs opacity-80">Viendo chats de tu hijo</p>
                    </div>
                    <div id="chatsList" class="flex-1 overflow-y-auto p-4 space-y-3">
                        <p class="text-center text-gray-500 mt-10"><i class="fa-solid fa-spinner fa-spin"></i> Cargando amigos...</p>
                    </div>
                </div>
            `;

            loadChats(userData.linkedTo, true); // true = readOnly/parentMode
        }

        // 3. CHILD DASHBOARD
        function renderChildDashboard() {
            mainContent.innerHTML = `
                <div class="flex flex-col h-full">
                    <!-- Profile Header Small -->
                    <div class="bg-white p-4 border-b flex justify-between items-center">
                        <div>
                            <h2 class="font-bold text-gray-800 text-lg">Mis Chats</h2>
                            <p class="text-xs text-indigo-500 font-mono bg-indigo-50 px-2 py-1 rounded inline-block">Código: ${userData.linkCode || '...'}</p>
                        </div>
                        <button id="addFriendBtn" class="bg-indigo-600 text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 active:scale-95 transition">
                            <i class="fa-solid fa-user-plus"></i>
                        </button>
                    </div>

                    <div id="chatsList" class="flex-1 overflow-y-auto p-4 space-y-3">
                        <!-- Chat Items -->
                        <div class="text-center mt-10 text-gray-400">
                            <i class="fa-solid fa-comments text-4xl mb-2"></i>
                            <p>No tienes chats aún.</p>
                            <p class="text-sm">¡Añade un amigo con el botón +!</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('addFriendBtn').onclick = renderAddFriendModal;
            loadChats(currentUser.uid, false);
        }

        function renderAddFriendModal() {
            mainContent.innerHTML = `
                <div class="flex flex-col h-full bg-gray-900 text-white p-6 items-center text-center">
                    <button id="backToDash" class="absolute top-4 left-4 text-gray-400 hover:text-white">
                        <i class="fa-solid fa-arrow-left text-2xl"></i>
                    </button>
                    
                    <h2 class="text-2xl font-bold mb-2 mt-8">Añadir Amigo</h2>
                    <p class="text-gray-400 text-sm mb-8">Para añadir a alguien, debéis estar <strong>físicamente juntos</strong>.</p>

                    <div class="flex flex-col gap-4 w-full max-w-xs">
                        <button id="showQrBtn" class="bg-indigo-600 p-6 rounded-xl border border-indigo-400 hover:bg-indigo-700 transition flex flex-col items-center">
                            <i class="fa-solid fa-qrcode text-4xl mb-2"></i>
                            <span class="font-bold">Mostrar mi QR</span>
                            <span class="text-xs opacity-70">Para que te escaneen</span>
                        </button>

                        <div class="flex items-center gap-2 opacity-50">
                            <div class="h-px bg-gray-500 flex-1"></div>
                            <span class="text-xs">O</span>
                            <div class="h-px bg-gray-500 flex-1"></div>
                        </div>

                        <button id="scanQrBtn" class="bg-emerald-600 p-6 rounded-xl border border-emerald-400 hover:bg-emerald-700 transition flex flex-col items-center">
                            <i class="fa-solid fa-camera text-4xl mb-2"></i>
                            <span class="font-bold">Escanear QR</span>
                            <span class="text-xs opacity-70">Escanear amigo</span>
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('backToDash').onclick = renderChildDashboard;
            document.getElementById('showQrBtn').onclick = startDynamicQR;
            document.getElementById('scanQrBtn').onclick = startScanner;
        }

        // --- DYNAMIC QR FEATURE (The Core Requirement) ---
        function startDynamicQR() {
            mainContent.innerHTML = `
                <div class="flex flex-col h-full bg-white items-center justify-center p-6 relative">
                    <button id="stopQr" class="absolute top-4 left-4 text-gray-600 hover:text-black">
                        <i class="fa-solid fa-xmark text-3xl"></i>
                    </button>
                    <h3 class="font-bold text-xl text-indigo-800 mb-2">Tu Código Seguro</h3>
                    <p class="text-xs text-center text-gray-500 mb-6 max-w-xs">Este código cambia cada 0.5s. Tu amigo debe escanearlo AHORA.</p>
                    
                    <div class="relative">
                        <div id="qrcode" class="border-4 border-indigo-500 p-2 rounded-xl"></div>
                        <!-- Security Overlay Effect -->
                        <div class="absolute inset-0 bg-indigo-500 opacity-10 animate-pulse-fast pointer-events-none rounded-xl"></div>
                    </div>

                    <div class="mt-8 flex items-center gap-2 text-indigo-600 font-mono text-xs">
                        <i class="fa-solid fa-lock"></i> Encriptado y Dinámico
                    </div>
                </div>
            `;

            const qrContainer = document.getElementById('qrcode');
            
            // Generate QR loop
            const updateQR = () => {
                qrContainer.innerHTML = "";
                // FORMAT: SAFECHAT:UID:TIMESTAMP
                const data = `SAFECHAT:${currentUser.uid}:${Date.now()}`;
                
                new QRCode(qrContainer, {
                    text: data,
                    width: 200,
                    height: 200,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.L
                });
            };

            updateQR();
            qrInterval = setInterval(updateQR, 500); // 0.5s requirement

            document.getElementById('stopQr').onclick = () => {
                clearInterval(qrInterval);
                renderChildDashboard();
            };
        }

        function startScanner() {
            mainContent.innerHTML = `
                <div class="flex flex-col h-full bg-black relative">
                     <button id="stopScan" class="absolute top-4 left-4 text-white z-20 bg-black/50 p-2 rounded-full">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div id="reader" class="w-full h-full object-cover"></div>
                    <div class="absolute bottom-10 left-0 w-full text-center text-white z-20">
                        <p class="bg-black/50 inline-block px-4 py-2 rounded-full text-sm">Apunta al QR de tu amigo</p>
                    </div>
                </div>
            `;

            html5QrcodeScanner = new Html5Qrcode("reader");
            
            const qrCodeSuccessCallback = async (decodedText, decodedResult) => {
                // FORMAT: SAFECHAT:UID:TIMESTAMP
                if (decodedText.startsWith("SAFECHAT:")) {
                    const parts = decodedText.split(":");
                    const friendUid = parts[1];
                    const timestamp = parseInt(parts[2]);
                    const now = Date.now();

                    // VALIDATION LOGIC
                    // We allow a slightly larger window (3s) to account for camera focus/processing time, 
                    // but the visual QR changes every 0.5s, making it impossible to screenshot and share effectively.
                    if (now - timestamp < 3000 && now - timestamp > -500) { 
                        html5QrcodeScanner.stop().then(async () => {
                            // Add Friend Logic
                            await addFriend(friendUid);
                        });
                    } else {
                        // Expired code logic (optional visual feedback)
                        // console.log("Code expired");
                    }
                }
            };

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
            .catch(err => {
                showToast("Error de cámara", true);
                renderChildDashboard();
            });

            document.getElementById('stopScan').onclick = () => {
                if(html5QrcodeScanner) {
                    html5QrcodeScanner.stop().then(() => renderChildDashboard()).catch(() => renderChildDashboard());
                } else {
                    renderChildDashboard();
                }
            };
        }

        async function addFriend(friendUid) {
            if (friendUid === currentUser.uid) {
                showToast("No puedes añadirte a ti mismo", true);
                renderChildDashboard();
                return;
            }

            try {
                // Create unique Chat ID (alphabetical sort to ensure uniqueness for pair)
                const chatId = [currentUser.uid, friendUid].sort().join("_");
                
                // Check if chat exists
                const chatRef = doc(db, "chats", chatId);
                const chatSnap = await getDoc(chatRef);

                if (!chatSnap.exists()) {
                    await setDoc(chatRef, {
                        participants: [currentUser.uid, friendUid],
                        lastMessage: "Chat iniciado",
                        lastUpdated: serverTimestamp()
                    });
                }

                // Add to both users' friend lists (subcollection or array, using array for simplicity in MVP)
                // Actually, let's just use the 'chats' collection logic to find friends. 
                // But we need to verify users exist.
                
                showToast("¡Amigo añadido con éxito!");
                renderChildDashboard();

            } catch (e) {
                showToast("Error añadiendo amigo", true);
                renderChildDashboard();
            }
        }

        // --- CHAT SYSTEM ---
        
        function loadChats(userId, isReadOnly) {
            const listContainer = document.getElementById('chatsList');
            const q = query(collection(db, "chats"), where("participants", "array-contains", userId), orderBy("lastUpdated", "desc"));

            unsubscribeChats = onSnapshot(q, async (snapshot) => {
                if (snapshot.empty) {
                    listContainer.innerHTML = `
                        <div class="text-center mt-10 text-gray-400">
                            <i class="fa-solid fa-comments text-4xl mb-2"></i>
                            <p>${isReadOnly ? 'Tu hijo no tiene chats.' : 'No tienes chats.'}</p>
                        </div>`;
                    return;
                }

                listContainer.innerHTML = "";
                
                for (const docSnap of snapshot.docs) {
                    const chat = docSnap.data();
                    const otherId = chat.participants.find(id => id !== userId);
                    
                    // Fetch other user name
                    const userDoc = await getDoc(doc(db, "users", otherId));
                    const otherName = userDoc.exists() ? userDoc.data().name : "Usuario desconocido";
                    const initial = otherName[0].toUpperCase();

                    const div = document.createElement('div');
                    div.className = "bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 cursor-pointer hover:bg-gray-50 transition";
                    div.innerHTML = `
                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold text-lg">
                            ${initial}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 truncate">${otherName}</h4>
                            <p class="text-sm text-gray-500 truncate">${chat.lastMessage || '...'}</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300"></i>
                    `;
                    div.onclick = () => renderChat(docSnap.id, otherName, isReadOnly);
                    listContainer.appendChild(div);
                }
            });
        }

        function renderChat(chatId, otherName, isReadOnly) {
            mainContent.innerHTML = `
                <div class="flex flex-col h-full bg-gray-50">
                    <div class="bg-white p-3 border-b shadow-sm flex items-center gap-3">
                        <button id="backBtn" class="text-gray-600 hover:text-indigo-600 p-2">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <div class="font-bold text-gray-800 flex-1">
                            ${otherName} ${isReadOnly ? '<span class="text-xs text-red-500 ml-2">(Solo lectura)</span>' : ''}
                        </div>
                    </div>

                    <div id="messagesArea" class="flex-1 overflow-y-auto p-4 space-y-2 flex flex-col">
                        <!-- Messages go here -->
                    </div>

                    ${!isReadOnly ? `
                    <form id="msgForm" class="p-3 bg-white border-t flex gap-2">
                        <input type="text" id="msgInput" class="flex-1 border rounded-full px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none bg-gray-50" placeholder="Escribe un mensaje..." autocomplete="off">
                        <button type="submit" class="bg-indigo-600 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-indigo-700">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </form>
                    ` : ''}
                </div>
            `;

            document.getElementById('backBtn').onclick = () => {
                if(unsubscribeMessages) unsubscribeMessages();
                if(isReadOnly) renderParentDashboard();
                else renderChildDashboard();
            };

            const msgsArea = document.getElementById('messagesArea');

            // Load Messages
            const q = query(collection(db, `chats/${chatId}/messages`), orderBy("timestamp", "asc"));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                msgsArea.innerHTML = "";
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    // In readOnly mode, we need to know who is who relative to the CHILD, not the logged in parent
                    // userData.linkedTo is the child ID.
                    const isMe = isReadOnly ? (msg.senderId === userData.linkedTo) : (msg.senderId === currentUser.uid);
                    
                    const bubble = document.createElement('div');
                    bubble.className = `message-bubble px-4 py-2 rounded-2xl text-sm ${isMe ? 'bg-indigo-600 text-white self-end rounded-tr-none' : 'bg-white border text-gray-800 self-start rounded-tl-none'}`;
                    bubble.innerText = msg.text;
                    msgsArea.appendChild(bubble);
                });
                msgsArea.scrollTop = msgsArea.scrollHeight;
            });

            if(!isReadOnly) {
                document.getElementById('msgForm').onsubmit = async (e) => {
                    e.preventDefault();
                    const input = document.getElementById('msgInput');
                    const text = input.value.trim();
                    if(!text) return;

                    input.value = "";
                    
                    // Add message
                    await addDoc(collection(db, `chats/${chatId}/messages`), {
                        text: text,
                        senderId: currentUser.uid,
                        timestamp: serverTimestamp()
                    });

                    // Update last message in chat
                    await updateDoc(doc(db, "chats", chatId), {
                        lastMessage: text,
                        lastUpdated: serverTimestamp()
                    });
                };
            }
        }

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    logoutBtn.classList.remove('hidden');
                    
                    if (userData.role === 'parent') {
                        renderParentDashboard();
                    } else {
                        renderChildDashboard();
                    }
                } else {
                    // Fallback if db entry missing (shouldn't happen with correct flow)
                    renderAuth();
                }
            } else {
                currentUser = null;
                userData = null;
                renderAuth();
            }
        });

        logoutBtn.onclick = () => {
            signOut(auth);
            if(unsubscribeChats) unsubscribeChats();
            if(unsubscribeMessages) unsubscribeMessages();
            if(qrInterval) clearInterval(qrInterval);
            if(html5QrcodeScanner) html5QrcodeScanner.stop();
        };

    </script>
</body>
</html>
